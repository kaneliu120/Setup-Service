name: Deploy to Azure Web Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: setup-service-web
  AZURE_API_NAME: setup-service-api
  NODE_VERSION: '20.x'

jobs:
  build-and-deploy-web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Build Web App
      run: |
        cd apps/web
        npm run build
        
    - name: Prepare Web Package
      run: |
        mkdir -p deploy_web
        cp -r apps/web/.next/standalone/. deploy_web/
        cp -r apps/web/public deploy_web/apps/web/public || true
        cp -r apps/web/.next/static deploy_web/apps/web/.next/static || true
        
    - name: Archive Web
      run: |
        cd deploy_web
        zip -r ../release_web.zip .

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy Web to Azure
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: release_web.zip

  build-and-deploy-api:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Build API
      run: |
        cd apps/api
        npm run build
        
    - name: Run Database Seeding
      run: |
        cd apps/api
        # 设置临时环境变量用于本地执行（或跳过，让 Azure 侧执行）
        # 这里我们更倾向于在部署后或作为部署的一部分运行
        
    - name: Prepare API Package
      run: |
        mkdir -p deploy_api
        cp -r apps/api/dist deploy_api/
        cp apps/api/package.json deploy_api/
        # 安装生产依赖
        cd deploy_api
        npm install --production
        
    - name: Archive API
      run: |
        cd deploy_api
        zip -r ../release_api.zip .

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy API to Azure
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_API_NAME }}
        package: release_api.zip
